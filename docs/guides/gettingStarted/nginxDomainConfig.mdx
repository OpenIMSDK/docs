# Nginx 域名配置
### 1. 前置条件
>(1)open-im-server 和 chat 成功启动（open-im-server 中 minio 的配置需要改变，详细参考：步骤3）

>(2)Nginx 成功安装（同时也安装了 ssl 模块）

>(3)成功申请两个 ssl 证书

### 2. 配置 nginx.conf 文件
假设 nginx 安装在 **/usr/local** 目录下

参照如下模板修改 **/usr/local/nginx/conf/nginx.conf** 文件

```

worker_processes  1;



events {
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile        on;
    keepalive_timeout  65;

        # open-im-server chat Corresponding deployment address and port  
        upstream msg_gateway{
	        server 127.0.0.1:10001;		#IM Message server address Multiple can be specified according to the deployment
	}
        upstream im_api{
        	server 127.0.0.1:10002;		#IM Group user api server address Multiple can be specified according to the deployment
	}
        upstream im_chat_api{
	        server 127.0.0.1:10008;		#IM Business version login registration server address Multiple can be specified according to the deployment
	}
        upstream im_admin_api{
        	server 127.0.0.1:10009;		#IM The admin address of the commercial version can specify multiple units according to the deployment situation
	}
        upstream minio_s3_2{
	        server 127.0.0.1:10005;		#Minio address can be assigned to multiple modules dependingon deployment
	}
        upstream pc_web{
	        server 127.0.0.1:11001;		#PC web address can be validate
	}
        upstream openim_admin{
	        server 127.0.0.1:11002;		#Admin backend address can be used for validation
	}

        server {
                listen       443; #Listening on port 443
                server_name  test-web.rentsoft.cn;  #Your domain name
                ssl on;
                ssl_certificate /usr/local/nginx/conf/ssh/test-web.rentsoft.cn_bundle.pem;  #Path of pem file for ssl certificate
	        ssl_certificate_key /usr/local/nginx/conf/ssh/test-web.rentsoft.cn.key;   #Key file path of ssl certificate

	        gzip on;
	        gzip_min_length 1k;
	        gzip_buffers 4 16k;
	        gzip_comp_level 2;
	        gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/wasm;
	        gzip_vary off;
	        gzip_disable "MSIE [1-6]\.";

	        default_type application/wasm;

                location / {
		        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
		        proxy_pass http://pc_web/;
                }

                location /msg_gateway{
	        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
		        proxy_pass http://msg_gateway/;
	        }
	
	        location ^~/api/{
	        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
	 	        proxy_pass http://im_api/;
	        }

	        location ^~/chat/{
		        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
		        proxy_pass http://im_chat_api/;
	        }

	        location ^~/im-minio-api/ {
        		proxy_set_header Host $http_host;
		        proxy_set_header X-Real-IP $remote_addr;
		        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
		        proxy_set_header X-Forwarded-Proto $scheme;
		        proxy_connect_timeout 300;

		        proxy_http_version 1.1;
 		        proxy_set_header Connection "";
		        chunked_transfer_encoding off;
		        proxy_pass http://minio_s3_2/; 
	        }
        }

        # openim-admin
        server {
                listen       443; #listening port
                server_name  test-admin.rentsoft.cn; #Your domain server_name
	        ssl on;
	        ssl_certificate /usr/local/nginx/conf/ssh/test-admin.rentsoft.cn_bundle.pem;  #Path of pem file for ssl certificate
                ssl_certificate_key /usr/local/nginx/conf/ssh/test-admin.rentsoft.cn.key;   #Key file path of ssl certificate

      
                gzip on;
                gzip_min_length 1k;
                gzip_buffers 4 16k;
                gzip_comp_level 2;
                gzip_types text/plain application/javascript application/x-javascript text/css application/xml text/javascript application/x-httpd-php image/jpeg image/gif image/png application/wasm;
                gzip_vary off;
                gzip_disable "MSIE [1-6]\.";

                default_type application/wasm;

                location / {
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
                        proxy_pass http://openim_admin/;
    
                }       

                location /msg_gateway{
                proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
                        proxy_pass http://msg_gateway/;
                }

                location ^~/api/{
                proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
                        proxy_pass http://im_api/;
                } 

                location ^~/chat/{
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
                        proxy_pass http://im_chat_api/;
                }

                location ^~/complete_admin/{
                        proxy_http_version 1.1;
                        proxy_set_header Upgrade $http_upgrade;
                        proxy_set_header Connection "Upgrade";
                        proxy_set_header X-real-ip $remote_addr;
                        proxy_set_header X-Forwarded-For $remote_addr;
                        proxy_pass http://im_admin_api/;
                }
        }

        #Redirection from HTTP to HTTPS redirection
        server {
                listen 80;
                server_name test-web.rentsoft.cn;        
                rewrite ^(.*)$ https://$host$1 permanent;
        }
}
```

### 3.Minio 的配置
打开 **open-im-server/config/config.yaml** 修改 Minio 对应的内容，并重启 open-im-server

```yaml
object:
enable: "minio"
apiURL: "https://test-web.rentsoft.cn/api" //10002
minio:
bucket: "openim"
endpoint: "http://172.28.0.1:10005"
accessKeyID: "root"
secretAccessKey: "openIM123"
sessionToken: ''
signEndpoint: "https://test-web.rentsoft.cn/im-minio-api" //10005
```

### 4.启动 Nginx
进入 **usr/local/nginx/sbin** 文件，执行以下命令
> ./nginx -s reload

### 5.使用对应的域名进行登录验证





