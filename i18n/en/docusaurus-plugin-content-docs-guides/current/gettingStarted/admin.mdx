---
title: 'Monitoring and Alert System'
sidebar_position: 6
---

## Component Description
When deploying with Docker Compose, the following components will be automatically deployed. If deploying from source code, these components need to be manually enabled in the docker-compose.yaml.

| Component Name  | Description                                       | Deployment Instructions                              |
|-----------------|---------------------------------------------------|------------------------------------------------------|
| openim-admin    | Management console, providing a monitoring page entry | Automatically enabled in both Docker and source code deployments |
| prometheus      | A monitoring system component for collecting and storing metric data | Automatically enabled in Docker; manual enablement required for source deployment |
| alertmanager    | Component for managing and sending alerts        | Automatically enabled in Docker; manual enablement required for source deployment |
| grafana         | Dashboard component for displaying monitoring data | Automatically enabled in Docker; manual enablement required for source deployment |
| node-exporter   | Collects metric information from nodes (e.g., servers) | Automatically enabled in Docker; manual enablement required for source deployment |

## Configuration File Description

| File Name                         | Description               | Modification Items                              |
|-----------------------------------|---------------------------|-------------------------------------------------|
| config/config.yaml                | openIM service configuration | prometheus.enable: true to enable              |
| config/prometheus.yml             | Prometheus configuration  | No modification needed                         |
| config/instance-down-rules.yml    | Alert rules               | Defaults to two rules (instance_down, database_insert_failure_alerts) |
| config/alertmanager.yml           | Alert management configuration | Needs configuration of sender and receiver email information |
| config/email.tmpl                 | Email alert template      | Default email template, can be modified as needed |
| config/templates/prometheus-dashboard.yaml | Custom dashboard | No modification needed                         |

## Logging into the Management Console

Enter `http://ip:11002` in your browser to access the management console. This IP is the server's OPENIM_IP, ensure your browser can access it. The default username and password are both chatAdmin.

import Image4 from './assets/admin.jpg';

<img src={Image4} width="700" alt="admin" />

## Logging into Grafana

First, log into the management console, then click the data monitoring menu on the left side, and enter the default username (admin) and password (admin) to log into Grafana.
![PC Web Interface](./assets/login1.png)

## Adding Prometheus Data Source

As shown in the image below, enter the URL of the Prometheus data source: http://172.28.0.1:19090 (19090 is the default Prometheus port) and click "Save and Test" to save.
![PC Web Interface](./assets/database.png)

![PC Web Interface](./assets/database2.png)

## Importing Custom Dashboard

Click the import button as shown in the image below to import the dashboard.
![PC Web Interface](./assets/dashboard.png)

Copy the contents from https://github.com/openimsdk/open-im-server/tree/main/config/templates/prometheus-dashboard.yaml into the area shown in the image below, then click the load button.
![PC Web Interface](./assets/dashboard2.png)

Select your Data Source and job, customize metric information as shown in the image below.
![PC Web Interface](./assets/dashboard3.png)

## Importing Node-Exporter Dashboard

Enter 1860 to import, or find other node-exporter dashboard views on the official website (https://grafana.com/grafana/dashboards/).
![PC Web Interface](./assets/dashboard4.png)

Node-exporter metric information, as shown in the image below.
![PC Web Interface](./assets/dashboard5.png)

## Alert Configuration File Description

1. Email alert architecture diagram: The Prometheus component loads the alert rule file instance-down-rules.yml and sends alerts meeting the criteria to the alertmanager component. The alertmanager component, upon loading alertmanager.yml and email.tmpl files, sends emails using the configured alert email information and the email template.
![PC Web Interface](./assets/alert2.png)

2. prometheus.yml file description: Mainly used to configure the path of alert rule files, the address of the alert management service, and the IP address for capturing monitoring data. Default configuration requires no modification.
```
# Alertmanager configuration
alerting:
  alertmanagers:
  - static_configs:
    - targets: ['172.28.0.1:19093']

# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.
rule_files:
  - "instance-down-rules.yml"
```

3. Alert rule instance-down-rules.yaml file description: By default, two email alert rules (instance_down, database_insert_failure_alerts) are implemented. To add more alert rules, you can do so in the instance-down-rules.yml file:
```
groups:
  - name: instance_down  # Alert rule one: Trigger an alert if a monitoring module crashes for more than one minute
    rules:


 - alert: InstanceDown
        expr: up == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Instance {{ $labels.instance }} down"
          description: "{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 1 minutes."

  - name: database_insert_failure_alerts # Alert rule two: Trigger an alert if msg_insert_redis_failed_total and msg_insert_mongo_failed_total metrics increase
    rules:
      - alert: DatabaseInsertFailed
        expr: (increase(msg_insert_redis_failed_total[5m]) > 0) or (increase(msg_insert_mongo_failed_total[5m]) > 0)
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Increase in MsgInsertRedisFailedCounter or MsgInsertMongoFailedCounter detected"
          description: "Either MsgInsertRedisFailedCounter or MsgInsertMongoFailedCounter has increased in the last 5 minutes, indicating failures in message insert operations to Redis or MongoDB, maybe the redis or mongodb is crash."
```

4. Alert management alertmanager.yml file description: Modify sender and receiver email configuration information to receive alert information. For alerts via DingTalk, WeChat Work, etc., modify alertmanager.yml accordingly. For reference, see the official alert management documentation: https://prometheus.io/docs/alerting/latest/alertmanager/
```
global:
  resolve_timeout: 5m
  smtp_from: alert@openim.io # Alert sender email
  smtp_smarthost: smtp.163.com:465 # Sender email SMTP address
  smtp_auth_username: alert@openim.io # Sender email authorization username, usually the same as smtp_from
  smtp_auth_password: YOURAUTHPASSWORD # Sender email authorization code
  smtp_require_tls: false
  smtp_hello: openim alert

templates:
  - /etc/alertmanager/email.tmpl # Email template

route:
  group_by: ['alertname']
  group_wait: 5s
  group_interval: 5s
  repeat_interval: 5m
  receiver: email
receivers:
  - name: email
    email_configs:
      - to: 'alert@example.com' # Recipient alert email
        html: '{{ template "email.to.html" . }}'
        headers: { Subject: "[OPENIM-SERVER]Alarm" }# Email title
        send_resolved: true
```

5. Email template file email.tmpl description: This file is in HTML format. The alert management module fills in the variable information and then renders it into an HTML file for email sending. It can be modified as needed:
```
{{ define "email.to.html" }}
{{ range .Alerts }}
<!-- Begin of OpenIM Alert -->
<div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
    <h3>OpenIM Alert</h3>
    <p><strong>Alert Program:</strong> Prometheus Alert</p>
    <p><strong>Severity Level:</strong> {{ .Labels.severity }}</p>
    <p><strong>Alert Type:</strong> {{ .Labels.alertname }}</p>
    <p><strong>Affected Host:</strong> {{ .Labels.instance }}</p>
    <p><strong>Affected Service:</strong> {{ .Labels.job }}</p>
    <p><strong>Alert Subject:</strong> {{ .Annotations.summary }}</p>
    <p><strong>Trigger Time:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
</div>
<!-- End of OpenIM Alert -->
{{ end }}
{{ end }}
```

## Alert Experience
You can manually trigger the instancedown alert rule. If deploying openim from source, execute the `make stop` command to stop the openim-server service. After waiting for more than 5 minutes, you will receive an alert email as shown below:

![PC Web Interface](./assets/alert6.png)

## Log System
If deploying the OpenIM service in a k8s environment using the helm chart method, you can view all OpenIM service logs through Grafana.
Currently, binary and Docker deployments have not integrated the Loki log collection component. To experience the Loki log collection feature, please use the helm chart deployment method.
For more details, please refer to the link: https://github.com/openimsdk/helm-charts/blob/main/docs/user-guide-zh.md
